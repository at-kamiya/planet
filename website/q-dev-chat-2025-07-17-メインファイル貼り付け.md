Amazon Q can now help you write, modify, and maintain code by combining the power of natural language understanding with the ability to take actions on your behalf such as directly making code changes, modifying files, and running commands.

---

Hi, I'm Amazon Q. I can answer your software development questions. 
                        Ask me to explain, debug, or optimize your code. 
                        You can enter `/` to see a list of quick actions.

---

いかに貼り付けるC言語のプログラムを、基本設計書に起こしてください。
＝＝＝＝＝＝
/*
* $id: $
*/

/************************************************************************/
/*!
 @file
 @brief 物件状態変化監視 関数定義\n
 
 システム名：    (I)ISS\n
 サブシステム名：(A2)物件監視\n
 機能ブロック名：(A20201)物件状態変化監視\n
 プログラム名：  A2_0201Main.c\n
 ソース名：      A2_0201Main.c\n\n
 
 関数名：物件状態変化監視メイン\n
 I/O関連：\n
 
 @warning \n
 @param   [in] argc        int型  パラメータ数\n
 @param   [in] argv        char型 パラメータ先頭ポインタ \n
 @return  exit(0)\n
 @return  exit(1)\n
 @sa      \n
 
 @author  上野　寿久\n
 @date    2006/2/21\n
 
 特記事項:\n
 
 変更履歴:\n
 変更管理番号  &quot;ISS@001&quot;\n
               （月日） 2007/04/16 \n
               （氏名） 北浦 雅也\n
               （内容）【PIT10069-IA2_01】(Purify検知)ﾒﾓﾘ操作によるｴﾗｰ検知 \n
 変更管理番号  &quot;ISS@002&quot;\n
               （月日） 2007/06/04 \n
               （氏名） 北浦 雅也\n
               （内容）【PI010307-IA2_01】受信API引数指定誤り \n
 変更管理番号   &quot;ISS_003&quot;\n
               （月日） 2014/03/26 \n
               （氏名） 小黒 浩章\n
               （内容）【PSPC0653-IA2_02】マンションシステムの発報回数異常 \n
                                          検知機能を追加 \n
 変更管理番号   &quot;ISS_004&quot;\n
               （月日） 2014/04/14 \n
               （氏名） 末廣 毅\n
               （内容）【PSPC0654-IA2_02】デュアル無線未情報対応 \n
 変更管理番号   &quot;ISS_005&quot;\n
               （月日） 2018/08/10 \n
               （氏名） 我妻 正浩\n
               （内容）【P2ITC0001-IA2_01】a2_stage1_1.com(a2rs0301)で応答なし\n
                        スリープ値見直し(100m秒)に伴い、マクロ化する\n
 変更管理番号   &quot;ISS_006&quot;\n
               （月日） 2019/07/18 \n
               （氏名） 我妻 正浩\n
               （内容）【P2ITY0004_IA2_017】【現行ISS】信号受信Ｓ切り替え後に\n
                                           ［本部装置ダウン］で新規事案表示される\n

*************************************************************************/

/*--------------------------&lt;&lt;    Include   &gt;&gt;--------------------------*/

#include        &lt;stdio.h&gt;
#include        &lt;signal.h&gt;

#include        &quot;a2_0201.h&quot;
#include        &quot;ik4/Zk4incd.h&quot;

/*--------------------------&lt;&lt;    define    &gt;&gt;--------------------------*/

#define                MYNAME                &quot;A2_0201Main&quot;

/*--------------------------&lt;&lt;    メイン    &gt;&gt;--------------------------*/

void main(int argc,char *argv[])
{
    int               irc;                /* リターンコード               */
    long              li;                 /* ループカウンター             */
    long              lrc;                /* リターンコード               */
    long              lbklen;             /* デブロッキング元データ       */
                                          /*                 データ長     */
    unsigned char     *phead;             /* デブロッキング後ヘッダー     */
    unsigned char     *pdata[MQ_MSGSIZE]; /* デブロッキング後データ       */
    long              llen[MQ_MSGSIZE];   /* デブロッキング後データ       */
                                          /*                 データ長     */
    long              lcnt;               /* デブロッキング後データ       */
                                          /*                 データ数     */
    short             tcase_no;           /* ケースNO.                    */
    A2_20201MSG       srecv;              /* M/Q受信フォーマット          */
    long              lmrsw;              /* M/Q スイッチ                 */
    short             t_cnt;              /* ログ送信判断カウント         */
    A2Z_SEND24_LOG    s_msg24;            /* ログ書き込みフォーマット     */
    int               isig;               /* 受信シグナル                 */
    sigset_t          sigset;             /* シグナル構造体               */
                                          /* ワーク変数                   */
    unsigned char     cWkdata[sizeof(A2_20201MSG)];

    CDBG_CRS(&quot;メイン スタート\n&quot;, NULL, A20201_LOGNAME);

/************************************************************************/
/*                                                                      */
/* 常駐プロセス立ち上げ処理                                             */
/*                                                                      */
/************************************************************************/
/************************************************************************/
/*                                                                      */
/* 子プロセス作成                                                       */
/*                                                                      */
/************************************************************************/

    sigemptyset( &amp;sigset );
    sigaddset( &amp;sigset, SIGUSR1 );
    sigaddset( &amp;sigset, SIGUSR2 );

/************************************************************************/
/* 子プロセス                                                           */
/************************************************************************/
    irc = fork();
    if ( irc == -1 )
    {
        g_serr.lkub = ZA2_SYSERR;
        g_serr.lsyo = errno;
        strcpy( g_serr.csysfunc, &quot;fork&quot; );
        CDBG_SYS(&quot;### fork() エラー\n&quot;, NULL, A20201_LOGNAME);
        exit( 1 );
    }
    else
    {
        if ( irc != 0 )
        {
            isig = 0;
            sigwait( &amp;sigset, &amp;isig );

            if ( isig == SIGUSR1 )
            {
                exit( 0 );
            }
            else
            {
                exit( 1 );
            }
        }
    }

/************************************************************************/
/* 子プロセス処理(子プロセス起動成功)                                   */
/************************************************************************/
/* 【ISS_005】-2018/08/10 我妻　削除 start */
/*    sleep( 5 ); */
/* 【ISS_005】-2018/08/10 我妻　削除 start */

/************************************************************************/
/* 初期処理                                                             */
/************************************************************************/

/* 【ISS@001】変更 start                                                     */
    t_cnt = 0;
/* 【ISS@001】変更 end                                                       */

    lrc = A2_0201Init( );

    if( lrc != A20201_NORMAL )
    {
        A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,MP_IA2020101,&amp;g_serr );
        Zk2_shm_epilog( ZA2_STATE_KUKAKU_STR );
        Zk2_shm_epilog( ZA2_KANRI_KUKAKU_STR );
        CDBG_SYS(&quot;### A2_0201Init() エラー\n&quot;, &amp;g_serr, A20201_LOGNAME);
/* 【ISS_005】-2018/08/10 我妻　変更 start */
/*        kill( getppid(), SIGUSR2 ); */
        IA2ZSY_END1;
/* 【ISS_005】-2018/08/10 我妻　変更 end */
        exit( 1 );
    }

/************************************************************************/
/* プロセス監視開始                                                     */
/************************************************************************/
    lrc = Zk4_process_minit( argv[0] );
    if ( lrc != ZK4_OK )
    {
        g_serr.lkub = ZA2_MYERR;
        g_serr.lsyo = lrc;
        strcpy( &amp;g_serr.cmyfunc[0], &quot;Zk4_process_minit&quot; );
        A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                   MP_IA2020101,&amp;g_serr );
        Zk2_shm_epilog( ZA2_STATE_KUKAKU_STR );
        Zk2_shm_epilog( ZA2_KANRI_KUKAKU_STR );
        CDBG_SYS(&quot;### Zk4_process_minit() エラー\n&quot;, &amp;g_serr, A20201_LOGNAME);
/* 【ISS_005】-2018/08/10 我妻　変更 start */
/*        kill( getppid(), SIGUSR2 ); */
        IA2ZSY_END1;
/* 【ISS_005】-2018/08/10 我妻　変更 end */
        exit( 1 );
    }

/************************************************************************/
/* 親プロセス終了                                                       */
/************************************************************************/
/* 【ISS_005】-2018/08/10 我妻　変更 start */
/*    kill( getppid(), SIGUSR1 ); */
    IA2ZSY_END0;
/* 【ISS_005】-2018/08/10 我妻　変更 end */

/************************************************************************/
/* ステータス確認                                                       */
/************************************************************************/
    lrc = A2_0201StChk();
    if ( lrc != A20201_NORMAL )
    {
        A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                       MP_IA2020101,&amp;g_serr );

        /* DBの切断 */
        A2_ZDisConnectDB();

        /* 通信切断 */
        Zk1_ComsTerminate();

        Zk2_File_Close( g_A20201_ksbc );        /* 送信ＢＵＦＦ（管制用）   */
        Zk2_File_Close( g_A20201_otwl );        /* 応答待ちリストファイル   */
        Zk2_File_Close( g_A20201_isdn );        /* ISDN障害物件ファイル     */
        Zk2_shm_epilog( ZA2_SIGNAL_KUKAKU_STR ); /* 信号情報テーブル        */
        Zk2_shm_epilog( ZA2_STATE_KUKAKU_STR  ); /* 物件ステータステーブル  */
        Zk2_shm_epilog( ZA2_KANRI_KUKAKU_STR  ); /* 物件監視管理テーブル    */
        CDBG_SYS(&quot;### A2_0201StChk() エラー\n&quot;, &amp;g_serr, A20201_LOGNAME);
        exit( 1 );
    }

    lmrsw = A2_Z_OFF;

    g_A20201_tcnt = ( short )0;
    g_A20201_tcnt_to61 = ( short )0;

    while ( 1 )
    {
        /****************************************************************/
        /* メッセージ受信                                               */
        /****************************************************************/
        while ( 1 )
        {
            /************************************************************/
            /* スタート・ストップ処理                                   */
            /************************************************************/
            lrc = A2_0201StrSp();
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                           MP_IA2020101,&amp;g_serr );
                CDBG_COM(&quot;## A2_0201StrSp() エラー\n&quot;, &amp;g_serr, A20201_LOGNAME);
                continue;
            }

            if ( g_A20201_tmente == A2_Z_ON )
            {
                lrc = A2_0201Send61((char *)&amp;s_msg24, &amp;g_serr, (short )1);
                if ( lrc != ZA2_NORMAL )
                {
                    A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                   MP_IA2020101,&amp;g_serr );
                    CDBG_COM(&quot;## A2_0201Send61() エラー\n&quot;,
                              &amp;g_serr,
                              A20201_LOGNAME);
                }

                lrc =  A2_0201Send24((char *)&amp;s_msg24, &amp;g_serr, (short)1);
                if ( lrc != ZA2_NORMAL )
                {
                    A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                   MP_IA2020101,&amp;g_serr );
                    CDBG_COM(&quot;## A2_0201Send24() エラー\n&quot;,
                              &amp;g_serr,
                              A20201_LOGNAME);
                }
                break;
            }

            memset(&amp;srecv, 0x00, sizeof(srecv));

            if ( lmrsw == A2_Z_OFF )
            {
                lmrsw = A2_Z_ON;
                lrc   = A2_ZRecvPC( ZA2_SID_20201, (char *)&amp;srecv,
/* 【ISS@002】変更 start                                                     */
/*                                    A20201_RECVSIZE,                       */
                                    ( long )sizeof( srecv ),
/* 【ISS@002】変更 end                                                       */
                                    ZK1_COMS_RECV_MODE_NORMAL,
                                    ZK1_COMS_TIMER_NOWAIT, &#39;\0&#39;, &amp;g_serr );
            }
            else
            {
                lmrsw = A2_Z_OFF;

                lrc   = A2_ZRecvPC( ZA2_SID_2020101, (char *)&amp;srecv,
/* 【ISS@002】変更 start                                                     */
/*                                    A20201_RECVSIZE,                       */
                                    ( long )sizeof( srecv ),
/* 【ISS@002】変更 end                                                       */
                                    ZK1_COMS_RECV_MODE_NORMAL,
                                    ZK1_COMS_TIMER_NOWAIT, &#39;\0&#39;, &amp;g_serr );
            }
            if ( lrc == ZA2_NORMAL )
            {
                t_cnt = ( short )0;
                break;
            }
            else
            {
                if ( ( g_serr.lkub == ZA2_MRERR ) &amp;&amp;
                     ( g_serr.lsyo == ZK1_COMS_TIMEOUT) )
                {
                    sleep( MQ_TIMER );
                    continue;
                }
                else if ( ( g_serr.lkub == ZA2_MRERR ) &amp;&amp;
                          ( g_serr.lsyo == ZK1_COMS_EMPTY_QUEUE ) )
                {
                    if ( lmrsw == A2_Z_ON )
                    {
                        usleep( 20000 );
                    }

                    t_cnt++;

                    if ( t_cnt == (short)125 )
                    {
                        lrc =  A2_0201Send61((char *)&amp;s_msg24,
                                             &amp;g_serr, (short )1);
                        if ( lrc != ZA2_NORMAL )
                        {
                            A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                                       MP_IA2020101,&amp;g_serr );
                            CDBG_COM(&quot;## A2_0201Send61() エラー\n&quot;,
                                      &amp;g_serr,
                                      A20201_LOGNAME);
                        }

                        lrc =  A2_0201Send24((char *)&amp;s_msg24,
                                             &amp;g_serr,
                                             (short)1);
                        if ( lrc != ZA2_NORMAL )
                        {
                            A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                                       MP_IA2020101,&amp;g_serr );
                            CDBG_COM(&quot;## A2_0201Send24() エラー\n&quot;,
                                      &amp;g_serr,
                                      A20201_LOGNAME);
                        }
/* 【ISS_006】-2019/07/18 我妻　追加 start                                     */
                        t_cnt = ( short )0;
/* 【ISS_006】-2019/07/18 我妻　追加 end                                       */
                    }

/* 【ISS_006】-2019/07/18 我妻　削除 start                                     */
                    /************************************************/
                    /* ログ送信処理（a2rs0204）                     */
                    /************************************************/
/*                  if ( ( t_cnt &gt; (short)125 ) &amp;&amp;                             */
/*                       ( g_A20201_tcnt &gt; ( short )0 ) )                      */
/*                  {                                                          */
                        /* メッセージ送信 */
/*                      lrc = A2_ZSendPC( ZA2_SID_20204,                       */
/*                                        ZK1_COMS_PRTY_NORMAL,                */
/*                                        (char *)&amp;g_A20201_ssend_2,           */
/*                                        g_A20201_lsendlen,                   */
/*                                        &amp;g_serr );                           */
/*                      if ( lrc != ZA2_NORMAL )                               */
/*                      {                                                      */
/*                          A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,  */
/*                                                     MP_IA2020101,&amp;g_serr ); */
/*                          CDBG_COM(&quot;## A2_ZSendPC() エラー\n&quot;,               */
/*                                    &amp;g_serr,                                 */
/*                                    A20201_LOGNAME);                         */
/*                      }                                                      */
/*                      g_A20201_tcnt = ( short )0;                            */
/*                  }                                                          */
/* 【ISS_006】-2019/07/18 我妻　削除 end                                       */
                    continue;
                }
                else
                {
                    A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                               MP_IA2020101,&amp;g_serr );
                    CDBG_COM(&quot;## A2_ZRecvPC() エラー\n&quot;,
                              &amp;g_serr,
                              A20201_LOGNAME);
                    continue;
                }
            }
        }

        /* メンテ開始 */
        if ( g_A20201_tmente == A2_Z_ON )
        {
            break;
        }

/************************************************************************/
/* ブロッキングデータ分割                                               */
/************************************************************************/
        lrc = A2_0201DeBlock( (char *)&amp;srecv, &amp;lbklen,
                              &amp;pdata[0], &amp;llen[0], &amp;lcnt );
        if ( lrc != A20201_NORMAL )
        {
            A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                       MP_IA2020101,&amp;g_serr );
            CDBG_COM(&quot;## A2_0201DeBlock() エラー\n&quot;,
                      &amp;g_serr,
                      A20201_LOGNAME);
            continue;
        }

        CDBG_COM(&quot;■ブロッキングデータ分割数↓\n&quot;, NULL, A20201_LOGNAME);
        NDBG_COM(1, lcnt, NULL, A20201_LOGNAME);

        for ( li = 0; li &lt; lcnt; li++ )
        {
/************************************************************************/
/* グローバル変数セット                                                 */
/************************************************************************/
            g_A20201_pdata  = pdata[li];
            g_A20201_llen   = llen[li];
            g_A20201_msgid  = srecv.sismg_hd.ut_msg_id;
            memcpy(cWkdata,(char *)pdata[li],sizeof(A2_20201MSG));
            g_A20201_pdata2 = cWkdata;

/************************************************************************/
/* ＥＯＦ処理                                                           */
/************************************************************************/
            if (( ((A2_DDATA *)g_A20201_pdata)-&gt;dn_head.tinkbn  ==
                    A2_INKB_TAN  ) &amp;&amp;
                ( ((A2_DDATA *)g_A20201_pdata)-&gt;dn_head.tmsgtyp ==
                    A2_MSGTYPE_D ) &amp;&amp;
                ( g_A20201_msgid == A2_ID_EOF ))
            {
                if ( g_A20201_tcnt &gt; ( short )0 )
                {
                    lrc = A2_ZSendPC( ZA2_SID_20204,
                                      ZK1_COMS_PRTY_NORMAL,
                                      (char *)&amp;g_A20201_ssend,
                                      g_A20201_lsendlen,
                                      &amp;g_serr );
                    if ( lrc != ZA2_NORMAL )
                    {
                        A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                       MP_IA2020101,&amp;g_serr );
                        CDBG_COM(&quot;## A2_ZSendPC() エラー\n&quot;,
                                  &amp;g_serr,
                                  A20201_LOGNAME);
                    }
                    g_A20201_tcnt = ( short )0;
                 }
                 sleep( MQ_TIMER );

                 lrc = A2_0201EOFSend();
                 if ( lrc != A20201_NORMAL )
                 {
                     A2_ZErrorProc( g_A20201_0870sad,
                                    g_A20201_0870kad,MP_IA2020101,&amp;g_serr );
                     CDBG_COM(&quot;## A2_0201EOFSend() エラー\n&quot;,
                                  &amp;g_serr,
                                  A20201_LOGNAME);
                 }
                 break;
            }

/************************************************************************/
/* フラグクリア処理                                                     */
/************************************************************************/
            A2_0201FlagClear();

/************************************************************************/
/* 無線断線監視異常チェック                                             */
/************************************************************************/
            lrc = A2_0201MusenDanChk();
            /* 【ISS_004】-2014/04/14 末廣 毅 追加 start */
            if ( lrc == A20201_NOSIGNAL )
            {
                continue;
            }
            /* 【ISS_004】-2014/04/14 末廣 毅 追加 end */
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                           MP_IA2020101,&amp;g_serr );
                CDBG_COM(&quot;## A2_0201MusenDanChk() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
            }

/************************************************************************/
/* 信号判別処理                                                         */
/************************************************************************/
            lrc = A2_0201SignalRule( &amp;tcase_no );
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc(g_A20201_0870sad,g_A20201_0870kad,
                                          MP_IA2020101,&amp;g_serr);
                CDBG_COM(&quot;## A2_0201SignalRule() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
                continue;
            }

            if ( tcase_no == 0 )
            {
                CDBG_CRS(&quot;# tcase_no == 0\n&quot;, NULL, A20201_LOGNAME);
                goto KAISEN_PROC;
            }

/************************************************************************/
/* 信号マトリックス処理                                                 */
/************************************************************************/
            lrc = A2_0201MaTrix( tcase_no );
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                               MP_IA2020101,&amp;g_serr );
                CDBG_COM(&quot;## A2_0201MaTrix() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
                continue;
            }

/************************************************************************/
/* フラグ処理                                                           */
/************************************************************************/
            lrc = A2_0201FlgProc();
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad,g_A20201_0870kad,
                                               MP_IA2020101,&amp;g_serr );
                CDBG_COM(&quot;## A2_0201FlgProc() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
                continue;
            }

/************************************************************************/
/* 発報回数監視処理                                                     */
/************************************************************************/
            lrc = A2_0201HKKansi();
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                               MP_IA2020101, &amp;g_serr );
                CDBG_COM(&quot;## A2_0201HKKansi() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
            }

/************************************************************************/
/* 回線状況反映                                                         */
/************************************************************************/
            KAISEN_PROC:;
            lrc = A2_0201DanFukkyuu( &amp;tcase_no );
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                               MP_IA2020101, &amp;g_serr );
                CDBG_COM(&quot;## A2_0201DanFukkyuu() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
            }

/************************************************************************/
/* ﾊﾝｸｽ開閉店時間監視処理                                               */
/************************************************************************/
            lrc = A2_0201Kaihei();
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                               MP_IA2020101, &amp;g_serr );
                CDBG_COM(&quot;## A2_0201Kaihei() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
            }

/************************************************************************/
/* HS不在解除処理                                                       */
/************************************************************************/
            lrc = A2_0201HSFzaiR();
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                               MP_IA2020101, &amp;g_serr );
                CDBG_COM(&quot;## A2_0201HSFzaiR() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
            }

            lrc = A2_0201D2S10Ijyo( &amp;tcase_no );
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                               MP_IA2020101, &amp;g_serr );
                CDBG_COM(&quot;## A2_0201D2S10Ijyo() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
            }

            lrc = A2_0201NoentIjou();
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                               MP_IA2020101, &amp;g_serr );
                CDBG_COM(&quot;## A2_0201NoentIjou() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
            }

/* 【ISS_003】-2014/03/26 小黒 浩章 追加 start */
/************************************************************************/
/* 発報回数監視処理（ＭＣＮ障害対策）                                   */
/************************************************************************/
            lrc = A2_0201HKKansi_MS();
            if ( lrc != A20201_NORMAL )
            {
                A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                               MP_IA2020101, &amp;g_serr );
                CDBG_SYS(&quot;## A2_0201HKKansi_MS() エラー\n&quot;,
                          &amp;g_serr,
                          A20201_LOGNAME);
            }

/* 【ISS_003】-2014/03/26 小黒 浩章 追加 end   */
        }
    }

/************************************************************************/
/*    プロセス監視終了                                                  */
/************************************************************************/
    lrc = Zk4_process_mterm( argv[0] );
    if ( lrc != ZK4_OK )
    {
        g_serr.lkub = ZA2_MYERR;
        g_serr.lsyo = lrc;
        strcpy( &amp;g_serr.cmyfunc[0], &quot;ZA8_Process_Mterm&quot; );
        A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                   MP_IA2020101, &amp;g_serr );

        /* DBの切断 */
        A2_ZDisConnectDB();

        /* 通信初期化 */
        Zk1_ComsTerminate();

        Zk2_File_Close( g_A20201_ksbc );        /* 送信ＢＵＦＦ（管制用） */
        Zk2_File_Close( g_A20201_otwl );        /* 応答待ちリストファイル */
        Zk2_File_Close( g_A20201_isdn );        /* ISDN障害物件ファイル   */

        Zk2_shm_epilog( ZA2_SIGNAL_KUKAKU_STR ); /* 信号情報テーブル      */
        Zk2_shm_epilog( ZA2_STATE_KUKAKU_STR  ); /* 物件ステータス        */
        Zk2_shm_epilog( ZA2_KANRI_KUKAKU_STR  ); /* 物件監視管理テーブル  */

        CDBG_SYS(&quot;### Zk4_process_mterm() エラー\n&quot;, &amp;g_serr, A20201_LOGNAME);
        exit( 1 );
    }

/************************************************************************/
/*    終了処理                                                          */
/************************************************************************/
    lrc = A2_0201End( );
    if( lrc != A20201_NORMAL )
    {
        A2_ZErrorProc( g_A20201_0870sad, g_A20201_0870kad,
                                   MP_IA2020101, &amp;g_serr );
        /* DBの切断 */
        A2_ZDisConnectDB();

        /* 通信初期化 */
        Zk1_ComsTerminate();

        Zk2_File_Close( g_A20201_ksbc );        /* 送信ＢＵＦＦ（管制用）  */
        Zk2_File_Close( g_A20201_otwl );        /* 応答待ちリストファイル  */
        Zk2_File_Close( g_A20201_isdn );        /* ISDN障害物件ファイル    */

        Zk2_shm_epilog( ZA2_SIGNAL_KUKAKU_STR ); /* 信号情報テーブル       */
        Zk2_shm_epilog( ZA2_STATE_KUKAKU_STR );  /* 物件ステータス         */
        Zk2_shm_epilog( ZA2_KANRI_KUKAKU_STR );  /* 物件監視管理テーブル   */

        CDBG_SYS(&quot;### A2_0201End() エラー\n&quot;, &amp;g_serr, A20201_LOGNAME);
        exit( 1 );
    }

    CDBG_COM(&quot;終了\n&quot;, NULL, A20201_LOGNAME);

    exit( 0 );
}

/*--------------------------&lt;&lt; End Of File &gt;&gt;---------------------------*/

---



# 基本設計書：物件状態変化監視メイン（A2_0201Main.c）

## 1. プログラム概要
- **システム名**: ISS
- **サブシステム名**: 物件監視
- **機能ブロック名**: 物件状態変化監視
- **プログラム名**: A2_0201Main.c

## 2. 機能概要
このプログラムは物件の状態変化を監視し、異常を検知するための常駐プロセスです。主に以下の機能を提供します：
- 物件からの信号受信と処理
- 物件状態の監視と変化の検知
- 異常状態の検出と通知
- 回線状況の監視と反映

## 3. 処理フロー

### 3.1 初期化処理
1. 子プロセスを作成（fork）
2. 初期化処理（A2_0201Init）の実行
3. プロセス監視開始（Zk4_process_minit）
4. ステータス確認（A2_0201StChk）

### 3.2 メインループ処理
1. スタート・ストップ処理（A2_0201StrSp）
2. メッセージ受信（A2_ZRecvPC）
3. ブロッキングデータ分割（A2_0201DeBlock）
4. 各種監視処理の実行：
   - 無線断線監視異常チェック
   - 信号判別処理
   - 信号マトリックス処理
   - フラグ処理
   - 発報回数監視処理
   - 回線状況反映
   - ハンクス開閉店時間監視処理
   - HS不在解除処理
   - その他異常監視処理

### 3.3 終了処理
1. プロセス監視終了（Zk4_process_mterm）
2. 終了処理（A2_0201End）の実行
   - DB切断
   - 通信終了
   - 各種ファイルクローズ
   - 共有メモリ解放

## 4. 主要機能

### 4.1 信号受信処理
- 2つの受信キュー（ZA2_SID_20201、ZA2_SID_2020101）を交互に監視
- タイムアウト時は一定時間待機後に再試行
- キューが空の場合は定期的にログ送信処理を実行

### 4.2 信号処理
- 受信した信号をブロッキングデータから分割
- 信号種別に応じた処理ルールの適用（A2_0201SignalRule）
- 信号マトリックス処理による状態遷移の判断（A2_0201MaTrix）

### 4.3 監視処理
- 無線断線監視（A2_0201MusenDanChk）
- 発報回数監視（A2_0201HKKansi）
- マンションシステム発報回数異常検知（A2_0201HKKansi_MS）
- 開閉店時間監視（A2_0201Kaihei）
- HS不在解除処理（A2_0201HSFzaiR）

### 4.4 異常検知と通知
- 異常検知時はエラー処理（A2_ZErrorProc）を実行
- ログ送信処理による通知（A2_0201Send24、A2_0201Send61）

## 5. エラー処理
- 各処理でのエラー発生時はエラーコードを返し、エラー情報を記録
- エラー情報はログに出力（CDBG_SYS、CDBG_COM）
- 致命的なエラー発生時はプロセスを終了

## 6. 特記事項
- 2018年8月にスリープ値の見直し（100ミリ秒）とマクロ化が行われた
- 2019年7月に信号受信S切り替え後の本部装置ダウン対応が実施された
- マンションシステムの発報回数異常検知機能が2014年3月に追加された
- デュアル無線未情報対応が2014年4月に実施された

## 7. 主要変数
- **g_A20201_tcnt**: ログ送信判断カウント
- **g_A20201_tmente**: メンテナンスモードフラグ
- **g_A20201_pdata**: 処理対象データポインタ
- **g_serr**: エラー情報格納構造体

## 8. 外部インターフェース
- **入力**: 物件からの信号データ（メッセージキュー経由）
- **出力**: 
  - 監視結果のログ
  - 異常検知時の通知メッセージ
  - 共有メモリ上の状態更新

## 9. 改善点
- エラー処理の統一化
- コード重複の削減
- タイムアウト値の最適化

---

では次に同じC言語のプログラムを作成した基本設計書に基づいて詳細設計書にしてください。

---



# 詳細設計書：物件状態変化監視メイン（A2_0201Main.c）

## 1. プログラム仕様

### 1.1 概要情報
- **システム名**: ISS
- **サブシステム名**: 物件監視
- **機能ブロック名**: 物件状態変化監視
- **プログラム名**: A2_0201Main.c
- **作成者**: 上野 寿久
- **作成日**: 2006/2/21

### 1.2 機能概要
物件の状態変化を監視し、異常を検知するための常駐プロセス。物件からの信号を受信・処理し、状態変化を検出して適切な処理を行う。

## 2. モジュール構成

### 2.1 インクルードファイル
```c
#include <stdio.h>
#include <signal.h>
#include "a2_0201.h"
#include "ik4/Zk4incd.h"
```

### 2.2 定数定義
```c
#define MYNAME "A2_0201Main"
```

## 3. 関数仕様

### 3.1 main関数
#### 機能
プログラムのエントリポイント。物件状態変化監視の主処理を実行する。

#### 引数
- `int argc`: パラメータ数
- `char *argv[]`: パラメータ配列

#### 戻り値
- `exit(0)`: 正常終了
- `exit(1)`: 異常終了

#### 使用変数
| 変数名 | 型 | 用途 |
|--------|------|------|
| irc | int | リターンコード |
| li | long | ループカウンター |
| lrc | long | リターンコード |
| lbklen | long | デブロッキング元データ長 |
| phead | unsigned char * | デブロッキング後ヘッダー |
| pdata | unsigned char * | デブロッキング後データ配列 |
| llen | long | デブロッキング後データ長配列 |
| lcnt | long | デブロッキング後データ数 |
| tcase_no | short | ケースNO. |
| srecv | A2_20201MSG | M/Q受信フォーマット |
| lmrsw | long | M/Q スイッチ |
| t_cnt | short | ログ送信判断カウント |
| s_msg24 | A2Z_SEND24_LOG | ログ書き込みフォーマット |
| isig | int | 受信シグナル |
| sigset | sigset_t | シグナル構造体 |
| cWkdata | unsigned char | ワーク変数 |

#### 処理フロー

1. **初期化処理**
   - シグナルセット初期化（SIGUSR1, SIGUSR2）
   - 子プロセス作成（fork）
   - 親プロセスはシグナル待機
   - 子プロセスは初期化処理実行（A2_0201Init）
   - プロセス監視開始（Zk4_process_minit）
   - 親プロセス終了通知（SIGUSR1）
   - ステータス確認（A2_0201StChk）

2. **メインループ処理**
   - スタート・ストップ処理（A2_0201StrSp）
   - メンテナンスモード確認
   - メッセージ受信処理
     - 2つの受信キュー（ZA2_SID_20201, ZA2_SID_2020101）を交互に監視
     - タイムアウト時は待機（sleep(MQ_TIMER)）
     - キューが空の場合は定期的にログ送信（t_cnt == 125）

3. **受信データ処理**
   - ブロッキングデータ分割（A2_0201DeBlock）
   - 分割データごとに以下の処理を実行:
     - グローバル変数セット
     - EOF処理確認
     - フラグクリア処理（A2_0201FlagClear）
     - 無線断線監視異常チェック（A2_0201MusenDanChk）
     - 信号判別処理（A2_0201SignalRule）
     - 信号マトリックス処理（A2_0201MaTrix）
     - フラグ処理（A2_0201FlgProc）
     - 発報回数監視処理（A2_0201HKKansi）
     - 回線状況反映（A2_0201DanFukkyuu）
     - ハンクス開閉店時間監視処理（A2_0201Kaihei）
     - HS不在解除処理（A2_0201HSFzaiR）
     - その他異常監視処理
     - マンションシステム発報回数異常検知（A2_0201HKKansi_MS）

4. **終了処理**
   - プロセス監視終了（Zk4_process_mterm）
   - 終了処理実行（A2_0201End）
     - DB切断（A2_ZDisConnectDB）
     - 通信終了（Zk1_ComsTerminate）
     - 各種ファイルクローズ（Zk2_File_Close）
     - 共有メモリ解放（Zk2_shm_epilog）

## 4. 詳細アルゴリズム

### 4.1 信号受信処理
1. 2つの受信キュー（ZA2_SID_20201, ZA2_SID_2020101）を交互に監視
   - lmrsw変数で切り替え制御（A2_Z_ON/A2_Z_OFF）
2. 受信タイムアウト時は一定時間待機（sleep(MQ_TIMER)）
3. キューが空の場合（ZK1_COMS_EMPTY_QUEUE）:
   - カウンタ（t_cnt）をインクリメント
   - カウンタが125に達したらログ送信処理実行
   - 2019年7月の修正でカウンタをリセット（t_cnt = 0）

### 4.2 ブロッキングデータ処理
1. 受信データをブロッキングデータから分割（A2_0201DeBlock）
2. 分割されたデータ数（lcnt）分ループ処理
3. 各データに対して一連の監視処理を実行

### 4.3 EOF処理
1. 受信データがEOFの場合:
   - ログカウンタ（g_A20201_tcnt）が0より大きい場合はログ送信
   - カウンタをリセット（g_A20201_tcnt = 0）
   - EOF送信処理実行（A2_0201EOFSend）

### 4.4 エラー処理
1. 各処理でエラー発生時:
   - エラー情報を構造体（g_serr）に格納
   - エラー処理関数（A2_ZErrorProc）を呼び出し
   - ログ出力（CDBG_SYS, CDBG_COM）
2. 致命的なエラー発生時:
   - リソース解放（DB切断、通信終了、ファイルクローズ、共有メモリ解放）
   - プロセス終了（exit(1)）

## 5. インターフェース仕様

### 5.1 入力インターフェース
- **メッセージキュー**: 物件からの信号データ受信
  - ZA2_SID_20201: 主受信キュー
  - ZA2_SID_2020101: 副受信キュー

### 5.2 出力インターフェース
- **メッセージキュー**: 監視結果通知
  - ZA2_SID_20204: ログ送信
- **ログファイル**: エラー情報、処理状況の記録
- **共有メモリ**: 物件状態情報の更新
  - ZA2_SIGNAL_KUKAKU_STR: 信号情報テーブル
  - ZA2_STATE_KUKAKU_STR: 物件ステータステーブル
  - ZA2_KANRI_KUKAKU_STR: 物件監視管理テーブル

### 5.3 ファイルインターフェース
- **g_A20201_ksbc**: 送信BUFF（管制用）
- **g_A20201_otwl**: 応答待ちリストファイル
- **g_A20201_isdn**: ISDN障害物件ファイル

## 6. エラーコード一覧

| エラーコード | 説明 |
|-------------|------|
| A20201_NORMAL | 正常終了 |
| A20201_NOSIGNAL | 信号なし（デュアル無線未情報対応） |
| ZA2_NORMAL | 正常終了 |
| ZA2_SYSERR | システムエラー |
| ZA2_MRERR | メッセージ受信エラー |
| ZA2_MYERR | 自プログラムエラー |
| ZK1_COMS_TIMEOUT | 受信タイムアウト |
| ZK1_COMS_EMPTY_QUEUE | 空キュー |
| ZK4_OK | 正常終了 |

## 7. 変更履歴

| 変更管理番号 | 日付 | 担当者 | 内容 |
|-------------|------|--------|------|
| ISS@001 | 2007/04/16 | 北浦 雅也 | (Purify検知)メモリ操作によるエラー検知 |
| ISS@002 | 2007/06/04 | 北浦 雅也 | 受信API引数指定誤り |
| ISS_003 | 2014/03/26 | 小黒 浩章 | マンションシステムの発報回数異常検知機能を追加 |
| ISS_004 | 2014/04/14 | 末廣 毅 | デュアル無線未情報対応 |
| ISS_005 | 2018/08/10 | 我妻 正浩 | スリープ値見直し(100m秒)に伴い、マクロ化 |
| ISS_006 | 2019/07/18 | 我妻 正浩 | 信号受信S切り替え後に[本部装置ダウン]で新規事案表示される問題対応 |

## 8. 注意事項・制約条件
- プロセス監視機能（Zk4_process_minit/Zk4_process_mterm）を使用
- 共有メモリを使用した物件状態管理
- 定期的なログ送信による状態通知
- 2018年の修正でスリープ値がマクロ化（IA2ZSY_END0, IA2ZSY_END1）
- 2019年の修正でログ送信処理のタイミング調整